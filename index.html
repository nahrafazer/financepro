<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyTrack - Dashboard Profesional</title>
    <style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');</style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Library untuk PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg: #020617; 
            --sidebar-glass: rgba(15, 23, 42, 0.7);
            --card-glass: rgba(30, 41, 59, 0.4); 
            --accent: #38bdf8;
            --text-main: #f8fafc;
            --text-dim: #94a3b8; 
            --success: #10b981;
            --danger: #f43f5e;
            --warning: #f59e0b;
            --border: rgba(255, 255, 255, 0.08);
            --input-bg: rgba(2, 6, 23, 0.4);
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative;
        }

        .blobs {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; filter: blur(90px);
            opacity: 0.6;
        }
        .blob {
            position: absolute; width: 600px; height: 600px;
            border-radius: 50%;
            opacity: 0.2; animation: move 25s infinite alternate ease-in-out;
        }
        .blob-1 { top: -10%; left: -5%; background: #0ea5e9; } 
        .blob-2 { bottom: -10%; right: -5%; background: #db2777; animation-delay: -5s; }
        .blob-3 { top: 30%; left: 30%; width: 450px; height: 450px; background: #ec4899; animation-duration: 20s; }

        @keyframes move {
            from { transform: translate(0, 0) scale(1); }
            to { transform: translate(120px, 80px) scale(1.1); }
        }

        /* Sidebar Desktop Default */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 2.5rem 1.5rem;
            flex-shrink: 0;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .brand {
            display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 3rem;
            padding: 0 0.5rem;
        }
        .brand-content { display: flex; align-items: center; gap: 12px; }
        .brand-logo {
            width: 34px; height: 34px; background: var(--accent);
            border-radius: 10px; display: flex; align-items: center;
            justify-content: center; color: #020617; box-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
        }

        /* Header Mobile Sembunyi di Desktop */
        .mobile-header {
            display: none;
        }

        .nav-link {
            display: flex; align-items: center; gap: 12px;
            padding: 12px; border-radius: 12px; color: var(--text-dim);
            font-size: 0.9rem; font-weight: 500; cursor: pointer;
            transition: 0.2s; margin-bottom: 4px; border: 1px solid transparent;
        }
        .nav-link.active { background: rgba(56, 189, 248, 0.1); color: var(--text-main); border: 1px solid rgba(56, 189, 248, 0.2); }
        .nav-link:hover:not(.active) { color: var(--text-main); background: rgba(255,255,255,0.03); }

        .user-pill {
            margin-top: auto; padding: 1.25rem; 
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border); border-radius: 20px;
        }
        .user-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .user-val { font-size: 0.85rem; font-weight: 600; color: var(--accent); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .btn-exit {
            margin-top: 1rem; width: 100%; background: transparent; color: #64748b;
            border: 1px solid var(--border); padding: 12px; border-radius: 12px;
            font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .btn-exit:hover { border-color: var(--danger); color: var(--danger); background: rgba(244, 63, 94, 0.05); }

        .main-container {
            flex: 1; display: flex; flex-direction: column;
            padding: 2.5rem 3rem; overflow: hidden; position: relative;
        }

        .page-header { flex-shrink: 0; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: flex-end; }
        .page-header h1 { margin: 0; font-size: 1.8rem; font-weight: 700; letter-spacing: -0.04em; }
        .page-header p { margin: 6px 0 0; color: var(--text-dim); font-size: 0.9rem; }

        .stats-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; flex-shrink: 0; margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--card-glass); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            padding: 1.5rem; border-radius: 24px; display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: 0.3s;
        }
        .stat-card:hover { border-color: rgba(255,255,255,0.2); transform: translateY(-3px); }
        .stat-meta { display: flex; align-items: center; gap: 8px; color: var(--text-dim); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.6rem; font-weight: 800; letter-spacing: -0.02em; color: #fff; }

        .content-grid {
            display: grid; grid-template-columns: 340px 1fr; gap: 1.5rem; flex: 1; min-height: 0;
        }
        
        .page-view {
            display: none;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-bottom: 2rem;
        }
        .page-view.active { display: flex; }

        .glass-panel {
            background: var(--card-glass); 
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border); border-radius: 28px;
            display: flex; flex-direction: column; overflow: hidden; 
            box-shadow: 0 15px 45px rgba(0,0,0,0.3);
        }
        .card-head { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); }
        .card-head h3 { margin: 0; font-size: 1rem; font-weight: 700; color: var(--accent); }

        .card-content { padding: 1.5rem; overflow-y: auto; flex: 1; }

        .form-item { margin-bottom: 1.25rem; }
        .form-item label { display: block; margin-bottom: 8px; font-size: 0.7rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, select {
            width: 100%; background: var(--input-bg); border: 1px solid var(--border);
            color: white; padding: 12px 16px; border-radius: 14px; font-family: 'Inter'; font-size: 0.9rem; transition: 0.3s;
        }
        select option { background: #0f172a; color: white; }
        input:focus, select:focus { border-color: var(--accent); outline: none; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        .btn-submit {
            width: 100%; background: var(--accent); color: #020617; border: none;
            padding: 14px; border-radius: 16px; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .btn-submit:hover { filter: brightness(1.15); transform: scale(1.02); }

        .table-area { 
            max-height: 420px; /* Batasi tinggi untuk sekitar 5 baris data + header */
            overflow-y: auto; 
            scrollbar-width: thin; 
            scrollbar-color: var(--border) transparent; 
        }
        .table-area::-webkit-scrollbar { width: 5px; }
        .table-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { 
            position: sticky; top: 0; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); z-index: 10;
            text-align: left; padding: 14px 1.5rem; font-size: 11px; 
            color: var(--text-dim); text-transform: uppercase; border-bottom: 1px solid var(--border);
        }
        td { padding: 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; transition: 0.2s; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        .date-separator {
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid var(--border);
        }
        .date-separator td {
            padding: 12px 1.5rem;
            font-size: 10px;
            font-weight: 800;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-bottom: 1px solid var(--border);
        }

        .col-desc { width: auto; font-weight: 500; }
        .col-amt { width: 180px; text-align: right; }
        .col-del { width: 120px; text-align: center; }

        .badge { padding: 4px 10px; border-radius: 8px; font-size: 9px; font-weight: 800; text-transform: uppercase; margin-top: 6px; display: inline-block; }
        .badge-pemasukan { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-pengeluaran { background: rgba(244, 63, 94, 0.15); color: var(--danger); border: 1px solid rgba(244, 63, 94, 0.3); }
        .badge-utang { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-piutang { background: rgba(56, 189, 248, 0.15); color: var(--accent); border: 1px solid rgba(56, 189, 248, 0.3); }
        .badge-source { background: rgba(255, 255, 255, 0.05); color: var(--text-dim); border: 1px solid var(--border); margin-left: 6px; }

        .btn-action-del, .btn-action-edit, .btn-action-settle { 
            background: transparent; color: var(--text-dim); border: none; cursor: pointer; 
            padding: 8px; border-radius: 8px; transition: 0.2s; display: inline-flex; 
        }
        .btn-action-del:hover { color: var(--danger); background: rgba(244, 63, 94, 0.1); }
        .btn-action-edit:hover { color: var(--accent); background: rgba(56, 189, 248, 0.1); }
        .btn-action-settle:hover { color: var(--success); background: rgba(16, 185, 129, 0.1); }

        #confirm-modal, #edit-modal, #settle-modal, #transfer-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.8); backdrop-filter: blur(12px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .modal-card {
            background: var(--card-glass); border: 1px solid var(--border); padding: 2.5rem;
            border-radius: 32px; width: 400px; text-align: left; box-shadow: 0 25px 60px rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
        }
        .modal-actions { display: flex; gap: 12px; margin-top: 2rem; }
        .m-btn { flex: 1; padding: 14px; border-radius: 16px; border: none; cursor: pointer; font-weight: 700; font-size: 0.9rem; transition: 0.2s; }
        .m-btn-cancel { background: rgba(255,255,255,0.05); color: #fff; }
        .m-btn-del { background: var(--danger); color: #fff; box-shadow: 0 8px 20px rgba(244, 63, 94, 0.2); }
        .m-btn-save { background: var(--accent); color: #020617; box-shadow: 0 8px 20px rgba(56, 189, 248, 0.2); }
        .m-btn-settle { background: var(--success); color: #fff; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2); }

        .balance-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;
            padding: 10px; 
        }
        .balance-card {
            background: var(--card-glass); border: 1px solid var(--border); border-radius: 24px; padding: 1.5rem;
            display: flex; flex-direction: column; gap: 8px; transition: 0.3s ease;
            position: relative;
        }
        .balance-card:hover { 
            border-color: var(--accent); 
            transform: scale(1.02); 
            z-index: 5; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        .balance-title { 
            font-size: 0.75rem; 
            font-weight: 700; 
            color: var(--text-dim); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .balance-amount { 
            font-size: 1.6rem; 
            font-weight: 800; 
            color: #fff; 
            letter-spacing: -0.02em;
        }

        .charts-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; flex: 1; min-height: 0;
        }
        .chart-card {
            background: var(--card-glass); 
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border); border-radius: 28px;
            padding: 1.5rem; display: flex; flex-direction: column;
            box-shadow: 0 15px 45px rgba(0,0,0,0.3);
        }

        .insight-highlight {
            grid-column: span 2;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .insight-label { color: var(--text-dim); font-size: 0.85rem; font-weight: 500; }
        .insight-value { color: var(--danger); font-size: 1.4rem; font-weight: 800; }

        .profile-container {
            display: grid; grid-template-columns: 300px 1fr; gap: 2rem;
        }
        .profile-header {
            text-align: center; padding: 2rem; background: rgba(255,255,255,0.02); border-radius: 24px; border: 1px solid var(--border);
        }
        .avatar-circle {
            width: 100px; height: 100px; background: linear-gradient(135deg, var(--accent), #7dd3fc); border-radius: 50%;
            margin: 0 auto 1.5rem; display: flex; align-items: center; justify-content: center; color: #020617;
            font-size: 2.5rem; font-weight: 800; box-shadow: 0 0 30px rgba(56, 189, 248, 0.4);
        }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .info-row:last-child { border-bottom: none; }
        .info-key { color: var(--text-dim); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .info-val { color: var(--text-main); font-size: 0.9rem; font-weight: 700; }

        /* Overlay Mobile */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            z-index: 90; display: none;
        }

        /* RESPONSIVE LAYOUTS */
        @media (max-width: 1024px) {
            body { flex-direction: column; height: 100vh; overflow: hidden; width: 100%; }
            
            .sidebar { 
                position: fixed;
                top: 0; left: 0;
                height: 100vh;
                width: 280px;
                transform: translateX(-100%);
                border-right: 1px solid var(--border);
            }
            .sidebar.active { transform: translateX(0); }
            
            .mobile-header {
                display: flex;
                flex-shrink: 0;
                align-items: center;
                justify-content: space-between;
                padding: 1.25rem 1.5rem;
                background: var(--sidebar-glass);
                backdrop-filter: blur(20px);
                border-bottom: 1px solid var(--border);
                z-index: 80;
            }

            .mobile-toggle {
                display: block;
                background: rgba(255,255,255,0.05);
                border: 1px solid var(--border);
                color: white;
                padding: 8px;
                border-radius: 10px;
                cursor: pointer;
                transition: 0.2s;
            }
            .mobile-toggle:hover { background: rgba(255,255,255,0.1); }

            .sidebar-overlay.active { display: block; }
            
            .main-container { 
                flex: 1;
                padding: 1.5rem; 
                overflow-y: auto; /* Pastikan area ini yang melakukan scroll */
                -webkit-overflow-scrolling: touch;
            }
            
            /* Pada mobile, area tabel tetap mengikuti batas tinggi agar scroll di dalam bekerja */
            .page-view { overflow: visible; height: auto; min-height: auto; flex: none; }

            .content-grid, .charts-container, .profile-container { grid-template-columns: 1fr; flex: none; gap: 1.5rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .table-area { max-height: 420px; overflow-y: auto; } /* Konsisten menampilkan 5 data di mobile */
            .insight-highlight { grid-column: span 1; }
            
            .sidebar .brand { display: none; }
        }

        /* Jam Digital Style */
        .time-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.2);
            padding: 6px 14px;
            border-radius: 12px;
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 700;
            margin-top: 8px;
            width: fit-content;
        }
    </style>
</head>
<body>

    <!-- OVERLAY UNTUK MOBILE -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- HEADER KHUSUS MOBILE -->
    <div class="mobile-header">
        <div class="brand-content">
            <div class="brand-logo"><i data-lucide="wallet-minimal"></i></div>
            <span style="font-size: 1.1rem; font-weight: 800; letter-spacing: -1px;">MONEYTRACK</span>
        </div>
        <button class="mobile-toggle" onclick="toggleSidebar()">
            <i data-lucide="menu" id="menu-icon"></i>
        </button>
    </div>

    <!-- DELETE MODAL -->
    <div id="confirm-modal">
        <div class="modal-card" style="text-align: center;">
            <div style="background: rgba(244, 63, 94, 0.15); width: 60px; height: 60px; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: var(--danger);">
                <i data-lucide="alert-triangle" style="width: 32px; height: 32px;"></i>
            </div>
            <h4 style="margin: 0; font-size: 1.25rem; font-weight: 800;">Hapus Data?</h4>
            <p style="font-size: 0.9rem; color: var(--text-dim); margin: 12px 0 0;">Transaksi ini akan dihapus permanen dari riwayat keuangan Anda.</p>
            <div class="modal-actions">
                <button class="m-btn m-btn-cancel" onclick="closeDelModal()">Batal</button>
                <button class="m-btn m-btn-del" id="exec-del">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <!-- SETTLE (LUNAS) MODAL -->
    <div id="settle-modal">
        <div class="modal-card">
            <div style="background: rgba(16, 185, 129, 0.15); width: 60px; height: 60px; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; color: var(--success);">
                <i data-lucide="check-circle" style="width: 32px; height: 32px;"></i>
            </div>
            <h4 style="margin: 0; font-size: 1.25rem; font-weight: 800;">Tandai Lunas?</h4>
            <p style="font-size: 0.85rem; color: var(--text-dim); margin: 8px 0 1.5rem;">Selesaikan catatan ini. Utang akan diubah menjadi Pengeluaran, dan Piutang akan menjadi Pemasukan.</p>
            
            <div class="form-item">
                <label>Keterangan Penyesuaian</label>
                <input type="text" id="settle-keterangan" placeholder="Contoh: Pembayaran Lunas ke Budi">
            </div>

            <div class="modal-actions">
                <button class="m-btn m-btn-cancel" onclick="closeSettleModal()">Batal</button>
                <button class="m-btn m-btn-settle" id="exec-settle">Simpan & Selesaikan</button>
            </div>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="edit-modal">
        <div class="modal-card">
            <h4 style="margin: 0 0 1.5rem; font-size: 1.25rem; font-weight: 800; color: var(--accent);">Edit Transaksi</h4>
            <input type="hidden" id="edit-id">
            <div class="form-item">
                <label>Tipe Aliran</label>
                <select id="edit-tipe">
                    <option value="pemasukan">Pemasukan</option>
                    <option value="pengeluaran">Pengeluaran</option>
                    <option value="utang">Utang</option>
                    <option value="piutang">Piutang</option>
                </select>
            </div>
            <div class="form-item">
                <label>Nominal (IDR)</label>
                <input type="number" id="edit-nominal">
            </div>
            <div class="form-item">
                <label>Keterangan</label>
                <input type="text" id="edit-keterangan">
            </div>
            <div class="form-item">
                <label>Tanggal</label>
                <input type="date" id="edit-tanggal">
            </div>
            <div class="modal-actions">
                <button class="m-btn m-btn-cancel" onclick="closeEditModal()">Batal</button>
                <button class="m-btn m-btn-save" onclick="simpanEdit()">Update Data</button>
            </div>
        </div>
    </div>

    <!-- TRANSFER MODAL (Fungsi Baru) -->
    <div id="transfer-modal">
        <div class="modal-card">
            <h4 style="margin: 0 0 1.5rem; font-size: 1.25rem; font-weight: 800; color: var(--accent);">Pindahkan Saldo</h4>
            <div class="form-item">
                <label>Dari Sumber</label>
                <select id="transfer-from">
                    <option value="Cash">Tunai / Cash</option>
                    <option value="BCA">Bank BCA</option>
                    <option value="Mandiri">Bank Mandiri</option>
                    <option value="BRI">Bank BRI</option>
                    <option value="Shopeepay">Shopeepay</option>
                    <option value="Gopay">Gopay</option>
                    <option value="OVO">OVO</option>
                    <option value="Dana">Dana</option>
                </select>
            </div>
            <div class="form-item">
                <label>Ke Tujuan</label>
                <select id="transfer-to">
                    <option value="BCA">Bank BCA</option>
                    <option value="Cash">Tunai / Cash</option>
                    <option value="Mandiri">Bank Mandiri</option>
                    <option value="BRI">Bank BRI</option>
                    <option value="Shopeepay">Shopeepay</option>
                    <option value="Gopay">Gopay</option>
                    <option value="OVO">OVO</option>
                    <option value="Dana">Dana</option>
                </select>
            </div>
            <div class="form-item">
                <label>Nominal (IDR)</label>
                <input type="number" id="transfer-nominal" placeholder="Contoh: 50000">
            </div>
            <div class="form-item">
                <label>Tanggal</label>
                <input type="date" id="transfer-tanggal">
            </div>
            <div class="modal-actions">
                <button class="m-btn m-btn-cancel" onclick="closeTransferModal()">Batal</button>
                <button class="m-btn m-btn-save" onclick="simpanTransfer()">Lakukan Transfer</button>
            </div>
        </div>
    </div>

    <div class="blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <aside class="sidebar" id="main-sidebar">
        <div class="brand">
            <div class="brand-content">
                <div class="brand-logo"><i data-lucide="wallet-minimal"></i></div>
                <span style="font-size: 1.25rem; font-weight: 800; letter-spacing: -1px;">MONEYTRACK</span>
            </div>
        </div>

        <nav>
            <div class="nav-link active" onclick="switchPage('dashboard', this); toggleSidebar(false)">
                <i data-lucide="layout-dashboard" style="width: 20px"></i> <span>Dashboard Utama</span>
            </div>
            <div class="nav-link" onclick="switchPage('balances', this); toggleSidebar(false)">
                <i data-lucide="wallet-2" style="width: 20px"></i> <span>Rincian Saldo</span>
            </div>
            <div class="nav-link" onclick="switchPage('debts', this); toggleSidebar(false)">
                <i data-lucide="hand-coins" style="width: 20px"></i> <span>Utang & Piutang</span>
            </div>
            <div class="nav-link" onclick="switchPage('charts', this); toggleSidebar(false)">
                <i data-lucide="bar-chart-3" style="width: 20px"></i> <span>Analisis Grafik</span>
            </div>
            <div class="nav-link" onclick="switchPage('profile', this); toggleSidebar(false)">
                <i data-lucide="user" style="width: 20px"></i> <span>Profil Saya</span>
            </div>
        </nav>

        <div class="user-pill">
            <div class="user-label">Otentikasi Sesi</div>
            <div class="user-val" id="user-display">Memuat...</div>
            <div id="session-info" style="font-size: 9px; color: #64748b; margin-top: 6px; font-weight: 600;"></div>
        </div>

        <button class="btn-exit" onclick="logout()">
            <i data-lucide="log-out" style="width: 16px"></i> Keluar Sesi
        </button>
    </aside>

    <main class="main-container" id="main-content">
        <header class="page-header">
            <div>
                <h1 id="greeting-txt">Dashboard Finansial</h1>
                <p id="sub-header-txt">Your Financial Assistant.</p>
                <div class="time-badge">
                    <i data-lucide="clock" style="width: 14px"></i>
                    <span id="local-clock">00:00:00</span>
                </div>
            </div>
            <div id="sync-status" style="font-size: 0.75rem; color: var(--accent); display: none;">
                <i data-lucide="refresh-cw" style="width: 14px; animation: spin 2s linear infinite;"></i> Sinkronisasi...
            </div>
        </header>

        <section class="stats-grid" id="global-stats-section">
            <div class="stat-card">
                <div class="stat-meta"><i data-lucide="landmark" style="width: 14px"></i> Total Saldo</div>
                <div class="stat-value" id="total-saldo">Rp 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-meta" style="color: var(--success)"><i data-lucide="arrow-up-right" style="width: 14px"></i> Pemasukan (30 Hari Terakhir)</div>
                <div class="stat-value" id="total-masuk" style="color: var(--success)">Rp 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-meta" style="color: var(--danger)"><i data-lucide="arrow-down-right" style="width: 14px"></i> Pengeluaran (30 Hari Terakhir)</div>
                <div class="stat-value" id="total-keluar" style="color: var(--danger)">Rp 0</div>
            </div>
        </section>

        <div id="dashboard-view" class="page-view active">
            <div class="content-grid">
                <div class="glass-panel">
                    <div class="card-head"><h3>Catat Transaksi</h3></div>
                    <div class="card-content">
                        <div class="form-item">
                            <label>Tipe Aliran</label>
                            <select id="tipe">
                                <option value="pemasukan">Pemasukan</option>
                                <option value="pengeluaran">Pengeluaran</option>
                            </select>
                        </div>
                        <div class="form-item">
                            <label>Sumber Dana</label>
                            <select id="source">
                                <option value="Cash">Tunai / Cash</option>
                                <option value="BCA">Bank BCA</option>
                                <option value="Mandiri">Bank Mandiri</option>
                                <option value="BRI">Bank BRI</option>
                                <option value="Shopeepay">Shopeepay</option>
                                <option value="Gopay">Gopay</option>
                                <option value="OVO">OVO</option>
                                <option value="Dana">Dana</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-item" id="manual-source-container" style="display: none;">
                            <label>Nama Sumber Lainnya</label>
                            <input type="text" id="manual_source" placeholder="Misal: Bank Jatim, Pinjol dll">
                        </div>
                        <div class="form-item">
                            <label>Nominal (IDR)</label>
                            <input type="number" id="nominal" placeholder="Contoh: 150000">
                        </div>
                        <div class="form-item">
                            <label>Keterangan</label>
                            <input type="text" id="keterangan" placeholder="Keterangan singkat...">
                        </div>
                        <div class="form-item">
                            <label>Tanggal</label>
                            <input type="date" id="tanggal_input">
                        </div>
                        <button class="btn-submit" onclick="simpanData()">
                            <i data-lucide="plus-circle" style="width: 20px"></i> Simpan Data
                        </button>
                    </div>
                </div>

                <div class="glass-panel">
                    <div class="card-head"><h3>Aktivitas Terbaru</h3></div>
                    <div class="table-area">
                        <table id="main-table">
                            <thead>
                                <tr>
                                    <th class="col-desc">Keterangan & Sumber</th>
                                    <th class="col-amt">Nominal</th>
                                    <th class="col-del">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="data-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="balances-view" class="page-view">
            <div class="balance-grid" id="source-balance-container"></div>
        </div>

        <div id="debts-view" class="page-view">
            <div class="content-grid">
                <div class="glass-panel">
                    <div class="card-head"><h3>Input Utang / Piutang</h3></div>
                    <div class="card-content">
                        <div class="form-item">
                            <label>Tipe Data</label>
                            <select id="debt-tipe">
                                <option value="utang">Utang</option>
                                <option value="piutang">Piutang</option>
                            </select>
                        </div>
                        <div class="form-item">
                            <label>Target Saldo</label>
                            <select id="debt-source-select">
                                <option value="Cash">Tunai / Cash</option>
                                <option value="BCA">Bank BCA</option>
                                <option value="Mandiri">Bank Mandiri</option>
                                <option value="BRI">Bank BRI</option>
                                <option value="Shopeepay">Shopeepay</option>
                                <option value="Gopay">Gopay</option>
                                <option value="OVO">OVO</option>
                                <option value="Dana">Dana</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-item" id="manual-debt-source-container" style="display: none;">
                            <label>Nama Sumber Lainnya</label>
                            <input type="text" id="manual_debt_source" placeholder="Misal: Bank Jatim, Pinjol dll">
                        </div>
                        <div class="form-item">
                            <label>Nominal (IDR)</label>
                            <input type="number" id="debt-nominal" placeholder="Jumlah uang...">
                        </div>
                        <div class="form-item">
                            <label>Keterangan</label>
                            <input type="text" id="debt-keterangan" placeholder="Keterangan tambahan...">
                        </div>
                        <div class="form-item">
                            <label>Tanggal Transaksi</label>
                            <input type="date" id="debt-tanggal">
                        </div>
                        <button class="btn-submit" style="background: var(--warning); color: #020617;" onclick="simpanDebt()">
                            <i data-lucide="save" style="width: 20px"></i> Simpan Catatan
                        </button>
                    </div>
                </div>

                <div class="glass-panel">
                    <div class="card-head"><h3>Daftar Belum Lunas</h3></div>
                    <div class="table-area">
                        <table>
                            <thead>
                                <tr>
                                    <th class="col-desc">Ket & Sumber</th>
                                    <th class="col-amt">Nominal</th>
                                    <th class="col-del">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="debt-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="charts-view" class="page-view">
            <div class="charts-container">
                <div class="chart-card insight-highlight">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="background: rgba(244, 63, 94, 0.1); padding: 12px; border-radius: 12px; color: var(--danger);">
                            <i data-lucide="trending-down" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div>
                            <div class="insight-label">Rata-Rata Pengeluaran Harian (7 Hari Terakhir)</div>
                            <div class="insight-value" id="avg-expense-weekly">Rp 0</div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="card-head" style="background:none; border:none; padding-bottom: 1rem;">
                        <h3 style="color: var(--success)">Pendapatan (7 Hari Terakhir)</h3>
                    </div>
                    <div style="flex:1; min-height: 0;">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="card-head" style="background:none; border:none; padding-bottom: 1rem;">
                        <h3 style="color: var(--danger)">Pengeluaran (7 Hari Terakhir)</h3>
                    </div>
                    <div style="flex:1; min-height: 0;">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="profile-view" class="page-view">
            <div class="profile-container">
                <div class="glass-panel profile-header">
                    <div class="avatar-circle" id="profile-initial">M</div>
                    <h2 id="profile-name" style="margin: 0; font-weight: 800; letter-spacing: -1px;">USER</h2>
                    <p style="color: var(--accent); font-size: 0.85rem; font-weight: 600;">Status: Pengguna Aktif</p>
                </div>
                <div class="glass-panel">
                    <div class="card-head"><h3>Detail Akun & Statistik</h3></div>
                    <div class="card-content">
                        <div class="info-row">
                            <span class="info-key">ID Pengguna</span>
                            <span class="info-val" id="prof-id">@user</span>
                        </div>
                        <div class="info-row">
                            <span class="info-key">Login Sejak</span>
                            <span class="info-val" id="prof-login">01 Jan 2025</span>
                        </div>
                        <div class="info-row">
                            <span class="info-key">Total Transaksi</span>
                            <span class="info-val" id="prof-total-tx">0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-key">Transaksi Terakhir</span>
                            <span class="info-val" id="prof-last-tx">-</span>
                        </div>
                        <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 12px;">
                            <!-- Tombol Download Laporan (Penambahan Baru) -->
                            <button class="btn-submit" style="background: var(--success); color: #fff;" onclick="downloadMonthlyReport()">
                                <i data-lucide="file-text" style="width: 18px"></i> Download Laporan Bulan Ini (PDF)
                            </button>
                            
                            <button class="btn-submit" style="background: rgba(255,255,255,0.05); color: #fff; border: 1px solid var(--border);" onclick="logout()">
                                <i data-lucide="log-out" style="width: 18px"></i> Keluar dari Perangkat Ini
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const _url = "https://uufpobwisjrocbyuzztx.supabase.co";
        const _key = "sb_publishable_iOq63sd-3dE061qVRxFkYw_JNEHMaeV";
        const supabaseClient = supabase.createClient(_url, _key);

        let targetIdForAction = null;
        let incomeChartInstance = null;
        let expenseChartInstance = null;
        let allTransactions = [];

        // Fitur Jam Lokasi Real-time
        function startClock() {
            const clockElement = document.getElementById('local-clock');
            
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                clockElement.innerText = timeString;
            }
            
            updateTime();
            setInterval(updateTime, 1000);
        }

        // Fungsi toggle sidebar mobile
        function toggleSidebar(force) {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const icon = document.getElementById('menu-icon');
            if (!sidebar) return;
            
            const isOpen = sidebar.classList.contains('active');
            const shouldOpen = typeof force === 'boolean' ? force : !isOpen;

            if (shouldOpen) {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                if (icon) icon.setAttribute('data-lucide', 'x');
            } else {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                if (icon) icon.setAttribute('data-lucide', 'menu');
            }
            lucide.createIcons();
        }

        document.getElementById('source').addEventListener('change', function() {
            document.getElementById('manual-source-container').style.display = this.value === 'Lainnya' ? 'block' : 'none';
        });

        document.getElementById('debt-source-select').addEventListener('change', function() {
            document.getElementById('manual-debt-source-container').style.display = this.value === 'Lainnya' ? 'block' : 'none';
        });

        function switchPage(pageId, element) {
            document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(pageId + '-view').classList.add('active');
            element.classList.add('active');
            document.getElementById('global-stats-section').style.display = pageId === 'profile' ? 'none' : 'grid';
            
            // Scroll ke atas saat pindah halaman di mobile
            const container = document.getElementById('main-content');
            if (container) container.scrollTop = 0;

            if(pageId === 'profile') renderProfileData();
        }

        function initApp() {
            const user = localStorage.getItem("current_user");
            const loginAt = localStorage.getItem("login_timestamp");
            if (!user || !loginAt || (Date.now() - parseInt(loginAt) > 30 * 24 * 60 * 60 * 1000)) return logout();

            document.getElementById('user-display').innerText = user.toUpperCase();
            const d = new Date(parseInt(loginAt));
            document.getElementById('session-info').innerText = "Aktif sejak: " + d.toLocaleDateString('id-ID');
            const jam = new Date().getHours();
            const sapaan = jam < 11 ? "Selamat Pagi" : jam < 15 ? "Selamat Siang" : jam < 19 ? "Selamat Sore" : "Selamat Malam";
            document.getElementById('greeting-txt').innerText = sapaan + ", " + user;

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal_input').value = today;
            document.getElementById('debt-tanggal').value = today;
            document.getElementById('transfer-tanggal').value = today;
            
            startClock();
            loadData();
        }

        async function loadData() {
            const user = localStorage.getItem("current_user");
            const sync = document.getElementById('sync-status');
            sync.style.display = 'block';

            const { data, error } = await supabaseClient.from('moneytrack')
                .select('*').eq('username', user).order('tanggal', { ascending: true });

            sync.style.display = 'none';
            if (!error) {
                allTransactions = data;
                const sorted = [...data].sort((a,b) => {
                    if (b.tanggal !== a.tanggal) return b.tanggal.localeCompare(a.tanggal);
                    const timeA = new Date(a.tanggal_pembuatan || a.created_at || 0);
                    const timeB = new Date(b.tanggal_pembuatan || b.created_at || 0);
                    return timeB - timeA;
                });

                const dashData = sorted.filter(t => t.tipe === 'pemasukan' || t.tipe === 'pengeluaran');
                const debtData = sorted.filter(t => t.tipe === 'utang' || t.tipe === 'piutang');

                renderTable(dashData);
                renderDebtTable(debtData);
                renderCharts(data);
                renderBalances(data);
            }
        }

        function renderBalances(data) {
            const container = document.getElementById('source-balance-container');
            container.innerHTML = "";

            // Menambahkan Kartu Transfer sebagai elemen aksi pertama agar bentuknya sama dengan saldo
            const transferCard = document.createElement('div');
            transferCard.className = "balance-card";
            transferCard.style.cursor = "pointer";
            transferCard.style.borderStyle = "dashed";
            transferCard.style.justifyContent = "center";
            transferCard.style.alignItems = "center";
            transferCard.style.background = "rgba(245, 158, 11, 0.05)";
            transferCard.style.borderColor = "rgba(245, 158, 11, 0.3)";
            transferCard.onclick = openTransferModal;
            transferCard.innerHTML = `
                <div style="text-align: center; color: var(--warning);">
                    <i data-lucide="repeat" style="width: 28px; height: 28px; margin-bottom: 8px;"></i>
                    <div class="balance-title" style="color: var(--warning); letter-spacing: 1px;">Pindahkan Saldo</div>
                </div>
            `;
            container.appendChild(transferCard);

            const balances = {};
            data.forEach(item => {
                const src = item.source || 'Cash';
                if (!balances[src]) balances[src] = 0;
                if (item.tipe === 'pemasukan' || item.tipe === 'utang') balances[src] += Number(item.nominal);
                else if(item.tipe === 'pengeluaran' || item.tipe === 'piutang') balances[src] -= Number(item.nominal);
            });

            Object.keys(balances).sort().forEach(name => {
                const card = document.createElement('div');
                card.className = "balance-card";
                card.innerHTML = `<div class="balance-title">${name}</div><div class="balance-amount" style="color: ${balances[name] < 0 ? 'var(--danger)' : '#fff'}">Rp ${balances[name].toLocaleString('id-ID')}</div>`;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function getTime(item) {
            const ts = item.tanggal_pembuatan || item.created_at;
            if (!ts) return "";
            return new Date(ts).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        }

        function renderTable(data) {
            const body = document.getElementById('data-body');
            body.innerHTML = "";
            let lastDate = null;

            if (data.length === 0) body.innerHTML = '<tr><td colspan="3" style="text-align:center; color:var(--text-dim); padding: 5rem;">Belum ada aktivitas.</td></tr>';
            else {
                data.forEach(item => {
                    const label = new Date(item.tanggal).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                    if (label !== lastDate) {
                        body.innerHTML += `<tr class="date-separator"><td colspan="3">${label}</td></tr>`;
                        lastDate = label;
                    }
                    const time = getTime(item);
                    body.innerHTML += `<tr><td class="col-desc"><div style="font-weight:700; color:#fff;">${item.keterangan || 'Tanpa Keterangan'}</div><div style="display:flex; align-items:center; gap:4px; margin-top:2px; flex-wrap: wrap;"><span class="badge badge-${item.tipe}">${item.tipe}</span><span class="badge badge-source">${item.source || 'Cash'}</span> ${time ? `<span class="badge badge-source">${time} WIB</span>` : ''}</div></td><td class="col-amt" style="font-weight:800; color:${item.tipe==='pemasukan'?'var(--success)':'var(--danger)'}">${item.tipe==='pemasukan'?'+':'-'} Rp ${Number(item.nominal).toLocaleString('id-ID')}</td><td class="col-del"><div style="display:flex; gap:4px; justify-content:center;"><button class="btn-action-edit" onclick="openEditModal('${item.id}')"><i data-lucide="edit-3" style="width:16px"></i></button><button class="btn-action-del" onclick="openDelModal('${item.id}')"><i data-lucide="trash-2" style="width:16px"></i></button></div></td></tr>`;
                });
            }

            // Hitung Total Saldo (Kumulatif)
            const sumAdds = allTransactions.reduce((acc, c) => (c.tipe === 'pemasukan' || c.tipe === 'utang') ? acc + Number(c.nominal) : acc, 0);
            const sumSubs = allTransactions.reduce((acc, c) => (c.tipe === 'pengeluaran' || c.tipe === 'piutang') ? acc + Number(c.nominal) : acc, 0);

            // Filter data untuk 30 hari terakhir
            const now = new Date();
            const cutoffDate = new Date();
            cutoffDate.setDate(now.getDate() - 30);
            const cutoffString = cutoffDate.toISOString().split('T')[0];

            const transactionsLast30Days = allTransactions.filter(t => t.tanggal >= cutoffString);

            // Hitung Total Pemasukan dan Pengeluaran (30 Hari Terakhir)
            const totalInLast30 = transactionsLast30Days.filter(t => t.tipe === 'pemasukan').reduce((a, b) => a + Number(b.nominal), 0);
            const totalOutLast30 = transactionsLast30Days.filter(t => t.tipe === 'pengeluaran').reduce((a, b) => a + Number(b.nominal), 0);

            document.getElementById('total-masuk').innerText = `Rp ${totalInLast30.toLocaleString('id-ID')}`;
            document.getElementById('total-keluar').innerText = `Rp ${totalOutLast30.toLocaleString('id-ID')}`;
            document.getElementById('total-saldo').innerText = `Rp ${(sumAdds - sumSubs).toLocaleString('id-ID')}`;
            lucide.createIcons();
        }

        function renderDebtTable(data) {
            const body = document.getElementById('debt-body');
            body.innerHTML = "";
            let lastDate = null;
            
            if (data.length === 0) body.innerHTML = '<tr><td colspan="3" style="text-align:center; color:var(--text-dim); padding: 5rem;">Tidak ada utang/piutang aktif.</td></tr>';
            else {
                data.forEach(item => {
                    const label = new Date(item.tanggal).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                    if (label !== lastDate) {
                        body.innerHTML += `<tr class="date-separator"><td colspan="3">${label}</td></tr>`;
                        lastDate = label;
                    }
                    const time = getTime(item);
                    body.innerHTML += `<tr><td class="col-desc"><div style="font-weight:700; color:#fff;">${item.keterangan || 'Tanpa Keterangan'}</div><div style="display:flex; align-items:center; gap:4px; margin-top:2px; flex-wrap: wrap;"><span class="badge badge-${item.tipe}">${item.tipe}</span><span class="badge badge-source">${item.source || 'Cash'}</span> ${time ? `<span class="badge badge-source">${time} WIB</span>` : ''}</div></td><td class="col-amt" style="font-weight:800; color:${item.tipe==='utang'?'var(--warning)':'var(--accent)'}">Rp ${Number(item.nominal).toLocaleString('id-ID')}</td><td class="col-del"><div style="display:flex; gap:4px; justify-content:center;"><button class="btn-action-settle" title="Tandai Lunas" onclick="openSettleModal('${item.id}')"><i data-lucide="check-circle-2" style="width:18px"></i></button><button class="btn-action-edit" onclick="openEditModal('${item.id}')"><i data-lucide="edit-3" style="width:16px"></i></button></div></td></tr>`;
                });
            }
            lucide.createIcons();
        }

        async function simpanData() {
            const user = localStorage.getItem("current_user");
            const tipe = document.getElementById('tipe').value;
            let source = document.getElementById('source').value;
            const nominal = document.getElementById('nominal').value;
            const keterangan = document.getElementById('keterangan').value;
            const tanggal = document.getElementById('tanggal_input').value;
            const now = new Date().toISOString();

            if (source === 'Lainnya') source = document.getElementById('manual_source').value.trim();
            if (!nominal || nominal <= 0 || !tanggal || !source) return;

            const { error } = await supabaseClient.from('moneytrack').insert([{ 
                username: user, tipe, source, nominal, keterangan, tanggal, 
                tanggal_pembuatan: now 
            }]);
            if (!error) {
                document.getElementById('nominal').value = "";
                document.getElementById('keterangan').value = "";
                loadData();
            }
        }

        async function simpanDebt() {
            const user = localStorage.getItem("current_user");
            const tipe = document.getElementById('debt-tipe').value;
            const nominal = document.getElementById('debt-nominal').value;
            const keterangan = document.getElementById('debt-keterangan').value.trim();
            const tanggal = document.getElementById('debt-tanggal').value;
            let source = document.getElementById('debt-source-select').value;
            const now = new Date().toISOString();

            if (source === 'Lainnya') source = document.getElementById('manual_debt_source').value.trim();
            if(!keterangan || !nominal || nominal <= 0 || !tanggal || !source) return;

            const { error } = await supabaseClient.from('moneytrack').insert([{ 
                username: user, tipe, source, nominal, keterangan, tanggal,
                tanggal_pembuatan: now 
            }]);
            if (!error) {
                document.getElementById('debt-nominal').value = "";
                document.getElementById('debt-keterangan').value = "";
                loadData();
            }
        }

        function openEditModal(id) {
            const tx = allTransactions.find(t => t.id == id);
            if(!tx) return;
            document.getElementById('edit-id').value = tx.id;
            document.getElementById('edit-tipe').value = tx.tipe;
            document.getElementById('edit-nominal').value = tx.nominal;
            document.getElementById('edit-keterangan').value = tx.keterangan;
            document.getElementById('edit-tanggal').value = tx.tanggal;
            document.getElementById('edit-modal').style.display = 'flex';
        }
        function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }
        async function simpanEdit() {
            const id = document.getElementById('edit-id').value;
            const payload = {
                tipe: document.getElementById('edit-tipe').value,
                nominal: document.getElementById('edit-nominal').value,
                keterangan: document.getElementById('edit-keterangan').value,
                tanggal: document.getElementById('edit-tanggal').value
            };
            const { error } = await supabaseClient.from('moneytrack').update(payload).eq('id', id);
            if(!error) { closeEditModal(); loadData(); }
        }

        // FUNGSI TRANSFER (Fungsi Baru)
        function openTransferModal() { document.getElementById('transfer-modal').style.display = 'flex'; }
        function closeTransferModal() { document.getElementById('transfer-modal').style.display = 'none'; }
        async function simpanTransfer() {
            const user = localStorage.getItem("current_user");
            const from = document.getElementById('transfer-from').value;
            const to = document.getElementById('transfer-to').value;
            const amt = document.getElementById('transfer-nominal').value;
            const date = document.getElementById('transfer-tanggal').value;
            const now = new Date().toISOString();

            if (!amt || amt <= 0 || from === to || !date) return;

            const sync = document.getElementById('sync-status');
            sync.style.display = 'block';

            // Catat Pengeluaran dari sumber asal
            const txFrom = { 
                username: user, tipe: 'pengeluaran', source: from, nominal: amt, 
                keterangan: `Pindah Saldo ke ${to}`, tanggal: date, tanggal_pembuatan: now 
            };
            // Catat Pemasukan ke sumber tujuan
            const txTo = { 
                username: user, tipe: 'pemasukan', source: to, nominal: amt, 
                keterangan: `Terima Saldo dari ${from}`, tanggal: date, tanggal_pembuatan: now 
            };

            const { error } = await supabaseClient.from('moneytrack').insert([txFrom, txTo]);
            
            sync.style.display = 'none';
            if (!error) {
                closeTransferModal();
                document.getElementById('transfer-nominal').value = "";
                loadData();
            }
        }

        function openDelModal(id) { targetIdForAction = id; document.getElementById('confirm-modal').style.display = 'flex'; }
        function closeDelModal() { targetIdForAction = null; document.getElementById('confirm-modal').style.display = 'none'; }
        document.getElementById('exec-del').onclick = async () => {
            const { error } = await supabaseClient.from('moneytrack').delete().eq('id', targetIdForAction);
            if (!error) { closeDelModal(); loadData(); }
        };

        function openSettleModal(id) {
            targetIdForAction = id;
            const tx = allTransactions.find(t => t.id == id);
            if (tx) document.getElementById('settle-keterangan').value = tx.keterangan || "";
            document.getElementById('settle-modal').style.display = 'flex';
        }
        function closeSettleModal() { targetIdForAction = null; document.getElementById('settle-modal').style.display = 'none'; }
        document.getElementById('exec-settle').onclick = async () => {
            const tx = allTransactions.find(t => t.id == targetIdForAction);
            if (!tx) return;
            const newKet = document.getElementById('settle-keterangan').value.trim();
            if (!newKet) return;
            let newTipe = tx.tipe === 'utang' ? 'pengeluaran' : (tx.tipe === 'piutang' ? 'pemasukan' : tx.tipe);
            const { error } = await supabaseClient.from('moneytrack').update({ tipe: newTipe, keterangan: newKet }).eq('id', targetIdForAction);
            if (!error) { closeSettleModal(); loadData(); }
        };

        function renderCharts(data) {
            const dashData = data.filter(t => t.tipe === 'pemasukan' || t.tipe === 'pengeluaran');
            const incD = {}, expD = {};
            dashData.forEach(i => {
                if (i.tipe === 'pemasukan') incD[i.tanggal] = (incD[i.tanggal] || 0) + Number(i.nominal);
                else expD[i.tanggal] = (expD[i.tanggal] || 0) + Number(i.nominal);
            });
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                days.push(d.toISOString().split('T')[0]);
            }
            const labels = days.map(d => new Date(d).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }));
            const incV = days.map(d => incD[d] || 0);
            const expV = days.map(d => expD[d] || 0);
            document.getElementById('avg-expense-weekly').innerText = `Rp ${Math.round(expV.reduce((a,b)=>a+b,0)/7).toLocaleString('id-ID')}`;
            const opts = { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#94a3b8'}},x:{ticks:{color:'#94a3b8'}}} };
            if (incomeChartInstance) incomeChartInstance.destroy();
            incomeChartInstance = new Chart(document.getElementById('incomeChart').getContext('2d'), { type:'bar', data:{labels, datasets:[{data:incV, backgroundColor:'rgba(16, 185, 129, 0.7)', borderRadius:6}]}, options:opts });
            if (expenseChartInstance) expenseChartInstance.destroy();
            expenseChartInstance = new Chart(document.getElementById('expenseChart').getContext('2d'), { type:'bar', data:{labels, datasets:[{data:expV, backgroundColor:'rgba(244, 63, 94, 0.7)', borderRadius:6}]}, options:opts });
        }

        function renderProfileData() {
            const user = localStorage.getItem("current_user");
            document.getElementById('profile-name').innerText = user.toUpperCase();
            document.getElementById('profile-initial').innerText = user.charAt(0).toUpperCase();
            document.getElementById('prof-id').innerText = "@" + user.toLowerCase();
            document.getElementById('prof-total-tx').innerText = allTransactions.length + " Transaksi";
            if (allTransactions.length > 0) {
                const last = [...allTransactions].sort((a,b) => new Date(b.tanggal)-new Date(a.tanggal))[0];
                document.getElementById('prof-last-tx').innerText = (last.keterangan || last.source) + " (" + new Date(last.tanggal).toLocaleDateString('id-ID') + ")";
            }
        }

        // FUNGSI BARU: DOWNLOAD LAPORAN BULANAN (PDF)
        async function downloadMonthlyReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const currentMonthName = monthNames[currentMonth];

            // Filter data khusus bulan ini
            const thisMonthData = allTransactions.filter(t => {
                const d = new Date(t.tanggal);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            }).sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            if (thisMonthData.length === 0) {
                const sync = document.getElementById('sync-status');
                sync.innerHTML = "Tidak ada data untuk bulan ini";
                sync.style.display = 'block';
                setTimeout(() => { sync.style.display = 'none'; sync.innerHTML = `<i data-lucide="refresh-cw" style="width: 14px; animation: spin 2s linear infinite;"></i> Sinkronisasi...`; }, 3000);
                return;
            }

            // Header PDF
            doc.setFontSize(18);
            doc.setTextColor(56, 189, 248);
            doc.text("Laporan Keuangan MoneyTrack", 14, 20);
            
            doc.setFontSize(11);
            doc.setTextColor(100, 100, 100);
            doc.text(`Periode: ${currentMonthName} ${currentYear}`, 14, 28);
            doc.text(`User ID: ${localStorage.getItem("current_user")}`, 14, 34);

            // Menyiapkan Data Tabel
            const tableData = thisMonthData.map((t, index) => [
                index + 1,
                t.tanggal,
                t.keterangan || '-',
                t.source || 'Cash',
                t.tipe.toUpperCase(),
                `Rp ${Number(t.nominal).toLocaleString('id-ID')}`
            ]);

            // Membuat Tabel
            doc.autoTable({
                startY: 40,
                head: [['No', 'Tanggal', 'Keterangan', 'Sumber', 'Tipe', 'Nominal']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [56, 189, 248], textColor: [255, 255, 255], fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                margin: { top: 40 }
            });

            // Simpan File
            doc.save(`Laporan_MoneyTrack_${currentMonthName}_${currentYear}.pdf`);
        }

        function logout() { localStorage.clear(); window.location.href = "login.html"; }
        initApp();
        lucide.createIcons();
    </script>
</body>
</html>
